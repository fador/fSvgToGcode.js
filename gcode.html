<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SVG to G-code</title>
  <script type="text/javascript" src="fSVGtoGcode.js"></script>
  <script type="text/javascript">

    var inputFilename = "";
    const config = {
      // Custom configuration options go here
      DEBUG: false,
      scale_x: 1.0,
      scale_y: 1.0,
      tool_down_gcode: "; Tool down\nM3",
      tool_up_gcode: "; Tool up\nM5",
      init_gcode: "G21\nG90\nG0 F1000\nG0 Z0\nG0 X0 Y0\n",
    };
 
    function dropHandler(ev) {
      console.log("File(s) dropped");

      // Prevent default behavior (Prevent file from being opened)
      ev.preventDefault();

      const reader = new FileReader();

      reader.addEventListener(
        "load",
        () => {
          // this will then display a text file
          let gcode = fSVGtoGcode(reader.result, config);
          var gcodeDiv = document.getElementById("g-code");
          var gcodeText = document.createTextNode(gcode.join("\n")+"\n");
          gcodeDiv.appendChild(gcodeText);
        },
        false,
      );


      if (ev.dataTransfer.items) {
        // Use DataTransferItemList interface to access the file(s)
        [...ev.dataTransfer.items].forEach((item, i) => {
          // If dropped items aren't files, reject them
          if (item.kind === "file") {
            const file = item.getAsFile();
            console.log(`… file[${i}].name = ${file.name}`);
            inputFilename = file.name.toLowerCase();
            reader.readAsText(file);
          }
        });
      } else {
        // Use DataTransfer interface to access the file(s)
        [...ev.dataTransfer.files].forEach((file, i) => {
          console.log(`… file[${i}].name = ${file.name}`);
          inputFilename = file.name.toLowerCase();
          reader.readAsText(file);
        });
      }
    }

    
    function uploadFile() {
      const reader = new FileReader();
      const fileInput = document.createElement("input");
      fileInput.type = "file";
      fileInput.accept = ".svg";
      reader.addEventListener(
        "load",
        () => {
          let gcode = fSVGtoGcode(reader.result, config);
          var gcodeDiv = document.getElementById("g-code");
          var gcodeText = document.createTextNode(gcode.join("\n")+"\n");
          gcodeDiv.appendChild(gcodeText);
        },
        false,
      );

      fileInput.onchange = e => { 
        var file = e.target.files[0]; 
        inputFilename = file.name.toLowerCase();
        reader.readAsText(file);
      };
      fileInput.click();

      fileInput.remove();
    }


    function dragOverHandler(ev) {
      console.log("File(s) in drop zone");

      // Prevent default behavior (Prevent file from being opened)
      ev.preventDefault();
    }

    function copyGcode() {
      var gcodeDiv = document.getElementById("g-code");
      var gcodeText = gcodeDiv.innerText;
      var textArea = document.createElement("textarea");
      textArea.value = gcodeText;
      document.body.appendChild(textArea);
      textArea.select();
      textArea.setSelectionRange(0, 999999);
      if(document.execCommand("Copy")) {
        console.log("Copied to clipboard");
      } else {
        console.log("Failed to copy to clipboard");
        alert("Failed to copy to clipboard fully. Please copy manually.");
      }
      textArea.remove();
    }

    function downloadGcode() {
      var gcodeDiv = document.getElementById("g-code");
      var gcodeText = gcodeDiv.innerText;
      var blob = new Blob([gcodeText], {type: "text/plain;charset=utf-8"});
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      if(inputFilename != "") link.download = inputFilename.replace(".svg", ".gcode");
      else link.download = "gcode.gcode";
      link.click();
      URL.revokeObjectURL(link.href);
      link.remove();
    }

    
  </script>
  <style type="text/css">
  #drop_zone {
    background-color: #EEE;
    border: #999 5px dashed;
    width: 290px;
    height: 200px;
    padding: 8px;
    font-size: 18px;
  }
  #g-code {
    background-color: #EEE;
    border: #999 1px;
    width: 400px;
    height: 800px;
    padding: -8px;
    font-size: 18px;
    overflow: scroll;
    white-space: pre;
  }
  </style>
</head>

<body>
  <div id="drop_zone" ondrop="dropHandler(event);" ondragover="dragOverHandler(event);" onclick="uploadFile();">
  <p>Drag a file to this <i>drop zone</i> or click to open file dialog.</p>
  </div>
  <br />
  Output: <a href="#" onClick="copyGcode(); return false;">copy</a> <a href="#" onClick="downloadGcode(); return false;">download</a> <a href="#" onClick="document.getElementById('g-code').innerHTML=''; return false;">clear</a>
  <br />
  <div id="g-code"></div>

</body>
</html>